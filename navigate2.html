<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Navigate - Accessible Chennai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0b596c;
            --primary-dark: #106e8d;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --blue-gradient: linear-gradient(135deg, #0a4861 0%, #145974 100%);
            --glow-blue: 0 0 20px rgba(59, 130, 246, 0.5);
            --glow-accent: 0 0 15px rgba(245, 158, 11, 0.6);
        }

        body {
            background: linear-gradient(135deg, #08354a 0%, #05374e 25%, #0e4e6c 50%, #0d5565 75%, #0e5f71 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            color: #ffffff;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .voice-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #10b981, #059669);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
            animation: voicePulse 2s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes voicePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 50px rgba(16, 185, 129, 1);
            }
        }

        .listening-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            display: none;
            border: 2px solid #10b981;
        }

        .sound-wave {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 20px 0;
        }

        .wave-bar {
            width: 6px;
            height: 30px;
            background: linear-gradient(to top, #10b981, #34d399);
            border-radius: 3px;
            animation: waveAnimation 1.5s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes waveAnimation {
            0%, 100% {
                height: 20px;
                opacity: 0.5;
            }
            50% {
                height: 50px;
                opacity: 1;
            }
        }

        .command-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #10b981;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .route-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #10b981;
            text-align: center;
            max-width: 600px;
            display: none;
        }

        .focus-indicator {
            outline: 4px solid #f59e0b !important;
            outline-offset: 4px !important;
            background: rgba(245, 158, 11, 0.1) !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .high-contrast {
            background: #000000 !important;
            color: #ffffff !important;
        }

        .high-contrast .glass,
        .high-contrast .glass-strong {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #000000 !important;
            border-color: #000000 !important;
        }

        .high-contrast button,
        .high-contrast input,
        .high-contrast select {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #000000 !important;
        }

        .reduced-motion * {
            animation: none !important;
            transition: none !important;
        }

        button, input, select {
            min-height: 48px;
            padding: 12px 16px;
            font-size: 18px;
            border-radius: 12px;
            border: 2px solid #3b82f6;
            transition: all 0.3s ease;
        }

        button:focus, input:focus, select:focus {
            outline: 4px solid #f59e0b !important;
            outline-offset: 4px !important;
            background: rgba(245, 158, 11, 0.1) !important;
            transform: scale(1.05);
        }

        #text-command-form input:focus {
            outline: 4px solid #f59e0b !important;
            outline-offset: 4px !important;
            background: rgba(245, 158, 11, 0.1) !important;
            transform: scale(1.05);
        }

        .emergency-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 24px;
            animation: emergencyPulse 3s ease-in-out infinite;
            z-index: 1000;
            cursor: pointer;
        }

        @keyframes emergencyPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            }
            50% {
                box-shadow: 0 0 40px rgba(239, 68, 68, 1);
            }
        }

        .navigation-active {
            border: 3px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .permission-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4000;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #f59e0b;
            text-align: center;
            max-width: 500px;
            display: none;
        }
    </style>
</head>
<body class="text-white">
    <!-- Permission Prompt -->
    <div id="permission-prompt" class="permission-prompt" role="dialog" aria-labelledby="permission-title">
        <h2 id="permission-title" class="text-2xl font-bold text-yellow-400 mb-6">Enable Voice & Location</h2>
        <p class="text-lg mb-6">This app needs access to your microphone for voice commands and location for navigation. Please click "Allow" when prompted by your browser.</p>
        <div class="space-x-4">
            <button onclick="requestPermissions()" class="bg-green-500 text-white px-8 py-4 rounded-xl text-xl font-bold">
                Enable Features
            </button>
            <button onclick="useTextMode()" class="bg-gray-500 text-white px-8 py-4 rounded-xl text-xl font-bold">
                Use Text Mode Only
            </button>
        </div>
    </div>

    <!-- Voice Status Indicator -->
    <div id="voice-status" class="voice-indicator" role="status" aria-label="Voice recognition status" onclick="toggleListening()">
        <i class="fas fa-microphone text-white text-2xl" aria-hidden="true"></i>
    </div>

    <!-- Listening Indicator -->
    <div id="listening-indicator" class="listening-indicator" role="alert">
        <h2 class="text-2xl font-bold text-green-400 mb-4">Listening...</h2>
        <div class="sound-wave">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>
        <p class="text-white">Speak your command clearly</p>
        <p class="text-sm text-gray-300 mt-2">Say "cancel" to stop listening</p>
    </div>

    <!-- Route Announcement Modal -->
    <div id="route-announcement" class="route-announcement" role="dialog" aria-labelledby="route-announcement-title" tabindex="-1">
        <h2 id="route-announcement-title" class="text-3xl font-bold text-green-400 mb-6">Route Found!</h2>
        <div id="route-details" class="text-left text-lg space-y-4"></div>
        <div class="mt-6 space-x-4">
            <button onclick="startNavigation()" class="bg-green-500 text-white px-8 py-4 rounded-xl text-xl font-bold" aria-label="Start navigation">
                Start Navigation
            </button>
            <button onclick="closeRouteAnnouncement()" class="bg-gray-500 text-white px-8 py-4 rounded-xl text-xl font-bold" aria-label="Close route announcement">
                Close
            </button>
        </div>
    </div>

    <!-- Command Help Panel -->
    <div id="command-help" class="command-help" role="region" aria-label="Voice commands help" tabindex="-1">
        <h3 class="text-lg font-bold text-green-400 mb-3">
            <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>
            Voice Commands Available
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
            <div>"Find route to [destination]"</div>
            <div>"Where am I?"</div>
            <div>"Help me navigate"</div>
            <div>"Repeat last instruction"</div>
            <div>"Emergency assistance"</div>
            <div>"Toggle high contrast"</div>
            <div>"Show nearby stations"</div>
            <div>"What's the weather?"</div>
        </div>
        <button onclick="toggleCommandHelp()" class="mt-3 text-blue-300 underline" aria-label="Toggle voice commands help">Hide Commands</button>
    </div>

    <!-- Emergency Button -->
    <button id="emergency-btn" class="emergency-button" onclick="handleEmergency()" aria-label="Emergency assistance">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
    </button>

    <!-- Main Content -->
    <main class="pt-8 pb-12 max-w-4xl mx-auto px-4">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="glass-strong p-8 rounded-3xl">
                <h1 class="text-4xl font-bold mb-4">
                    <i class="fas fa-microphone-alt text-blue-300 mr-3" aria-hidden="true"></i>
                    Voice Navigate Chennai
                </h1>
                <p class="text-xl text-blue-200 mb-6">Fully voice-controlled accessible navigation for Chennai</p>
                <div id="voice-status-text" class="text-lg font-semibold text-green-400" role="status">
                    🎤 Initializing voice assistance...
                </div>
            </div>
        </header>

        <!-- Current Status -->
        <section class="mb-8">
            <div class="glass p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-map-marker-alt text-green-400 mr-2" aria-hidden="true"></i>
                    Current Status
                </h2>
                <div id="current-status" class="space-y-3 text-lg">
                    <div>📍 Location: <span id="current-location">Detecting...</span></div>
                    <div>🎯 Destination: <span id="destination-status">None set</span></div>
                    <div>🚌 Next Transport: <span id="next-transport">Searching...</span></div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="mb-8">
            <div class="glass p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-bolt text-yellow-400 mr-2" aria-hidden="true"></i>
                    Quick Voice Commands
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="triggerVoiceCommand('find route')" class="glass p-4 rounded-xl text-left hover:bg-white/10 transition" aria-label="Find route command">
                        <div class="text-lg font-semibold">🎯 Find Route</div>
                        <div class="text-sm text-gray-300">Say: "Find route to [destination]"</div>
                    </button>
                    <button onclick="triggerVoiceCommand('where am i')" class="glass p-4 rounded-xl text-left hover:bg-white/10 transition" aria-label="Current location command">
                        <div class="text-lg font-semibold">📍 Current Location</div>
                        <div class="text-sm text-gray-300">Say: "Where am I?"</div>
                    </button>
                    <button onclick="triggerVoiceCommand('nearby stations')" class="glass p-4 rounded-xl text-left hover:bg-white/10 transition" aria-label="Nearby transit command">
                        <div class="text-lg font-semibold">🚌 Nearby Transit</div>
                        <div class="text-sm text-gray-300">Say: "Show nearby stations"</div>
                    </button>
                    <button onclick="triggerVoiceCommand('help')" class="glass p-4 rounded-xl text-left hover:bg-white/10 transition" aria-label="Get help command">
                        <div class="text-lg font-semibold">❓ Get Help</div>
                        <div class="text-sm text-gray-300">Say: "Help me navigate"</div>
                    </button>
                </div>
            </div>
        </section>

        <!-- Live Transit Info -->
        <section class="mb-8">
            <div class="glass p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-broadcast-tower text-blue-400 mr-2" aria-hidden="true"></i>
                    Live Transit Updates
                </h2>
                <div id="transit-info" class="space-y-4 text-lg">
                    <div class="flex justify-between">
                        <span>🚇 Metro Status:</span>
                        <span id="metro-status" class="text-green-400">Normal Service</span>
                    </div>
                    <div class="flex justify-between">
                        <span>🚌 Bus Status:</span>
                        <span id="bus-status" class="text-yellow-400">Minor Delays</span>
                    </div>
                    <div class="flex justify-between">
                        <span>🌤️ Weather:</span>
                        <span id="weather-status" class="text-blue-300">Partly Cloudy, 29°C</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Instructions (Hidden by default) -->
        <section id="navigation-section" class="mb-8" style="display: none;">
            <div class="glass p-6 rounded-2xl navigation-active">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-route text-green-400 mr-2" aria-hidden="true"></i>
                    Navigation Active
                </h2>
                <div id="navigation-instructions" class="space-y-4 text-lg">
                    <!-- Navigation instructions will be populated here -->
                </div>
                <div class="mt-6 space-x-4">
                    <button onclick="stopNavigation()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold">
                        Stop Navigation
                    </button>
                    <button onclick="repeatInstruction()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold">
                        Repeat Instruction
                    </button>
                </div>
            </div>
        </section>

        <!-- Hidden Screen Reader Content -->
        <div class="sr-only" aria-live="polite" aria-atomic="true" id="screen-reader-announcements"></div>
    </main>

    <script>
        // Global variables
        let speechSynthesis = window.speechSynthesis;
        let speechRecognition = null;
        let isListening = false;
        let currentLocation = null;
        let destination = null;
        let voiceQueue = [];
        let isHighContrast = false;
        let lastAnnouncement = '';
        let updateInterval = null;
        let proximityInterval = null;
        let isSpeaking = false;
        let isNavigating = false;
        let currentRoute = null;
        let currentInstructionIndex = 0;
        let voiceEnabled = false;
        let locationEnabled = false;

        // Chennai locations database
        const chennaiLocations = [
            'Adyar', 'Alwarpet', 'Anna Nagar', 'Ashok Nagar', 'Besant Nagar', 'Chetpet',
            'Chennai Central Railway Station', 'Chennai International Airport', 'Chromepet',
            'Egmore', 'Express Avenue Mall', 'Guindy', 'Kilpauk', 'Kodambakkam', 'Koyambedu',
            'Marina Beach', 'Mount Road', 'Mylapore', 'Nungambakkam', 'Perambur',
            'Phoenix MarketCity Mall', 'Royapettah', 'Saidapet', 'T Nagar', 'Tambaram',
            'Teynampet', 'Thiruvanmiyur', 'Vadapalani', 'Velachery'
        ];

        // Sample route data
        const routeDatabase = {
            'marina beach': {
                from: 'Current Location',
                to: 'Marina Beach',
                duration: '25 minutes',
                distance: '8.5 km',
                instructions: [
                    'Head north on your current street for 200 meters',
                    'Turn right onto Anna Salai and walk 300 meters to the bus stop',
                    'Board Bus 21G towards Marina Beach',
                    'Travel for 15 minutes (8 stops)',
                    'Get off at Marina Beach bus stop',
                    'Walk 100 meters east to reach Marina Beach'
                ],
                transport: ['Walking', 'Bus 21G']
            },
            't nagar': {
                from: 'Current Location',
                to: 'T Nagar',
                duration: '20 minutes',
                distance: '6.2 km',
                instructions: [
                    'Walk 150 meters to the nearest metro station',
                    'Board the Blue Line metro towards Airport',
                    'Travel for 12 minutes (4 stations)',
                    'Get off at T Nagar metro station',
                    'Exit through Gate 2 and you will be in T Nagar shopping area'
                ],
                transport: ['Walking', 'Metro Blue Line']
            }
        };

        // Initialize the voice navigation system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing system...');
            
            // Show permission prompt first
            showPermissionPrompt();
            
            // Initialize other systems
            updateTransitInfo();
            setupKeyboardShortcuts();
        });

        function showPermissionPrompt() {
            const permissionPrompt = document.getElementById('permission-prompt');
            permissionPrompt.style.display = 'block';
            
            // Update status
            document.getElementById('voice-status-text').textContent = '🎤 Permissions required for full functionality';
        }

        async function requestPermissions() {
            const permissionPrompt = document.getElementById('permission-prompt');
            let permissionsGranted = true;

            try {
                // Request microphone permission
                console.log('Requesting microphone permission...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone permission granted');
                voiceEnabled = true;
                
                // Stop the stream immediately as we just needed permission
                stream.getTracks().forEach(track => track.stop());
                
                // Request location permission
                console.log('Requesting location permission...');
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('Location permission granted');
                            locationEnabled = true;
                            resolve(position);
                        },
                        (error) => {
                            console.log('Location permission denied:', error);
                            reject(error);
                        },
                        { timeout: 10000 }
                    );
                });

            } catch (error) {
                console.error('Permission error:', error);
                permissionsGranted = false;
                
                if (error.name === 'NotAllowedError') {
                    alert('Microphone or location access was denied. You can still use the app with text input, but voice and precise location features will be limited.');
                } else if (error.name === 'NotFoundError') {
                    alert('No microphone found. You can still use the app with text input.');
                } else {
                    alert('Error accessing device features. You can still use the app with limited functionality.');
                }
            }

            // Hide permission prompt
            permissionPrompt.style.display = 'none';

            // Initialize the appropriate systems
            if (voiceEnabled) {
                await initializeVoiceSystem();
            } else {
                showTextInputFallback();
            }

            if (locationEnabled) {
                detectCurrentLocation();
            } else {
                document.getElementById('current-location').textContent = 'Location access denied';
            }

            // Start welcome sequence
            setTimeout(() => {
                startWelcomeSequence();
            }, 500);
        }

        function useTextMode() {
            document.getElementById('permission-prompt').style.display = 'none';
            document.getElementById('voice-status-text').textContent = '⌨️ Text mode active - Voice features disabled';
            
            showTextInputFallback();
            
            // Still try to get location without asking for microphone
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        locationEnabled = true;
                        detectCurrentLocation();
                    },
                    (error) => {
                        document.getElementById('current-location').textContent = 'Location unavailable';
                    }
                );
            }

            // Start welcome sequence without voice
            setTimeout(() => {
                startWelcomeSequence();
            }, 500);
        }

        async function initializeVoiceSystem() {
            console.log('Initializing voice system...');
            
            // Setup Speech Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('Speech recognition not supported');
                announceError('Voice recognition is not supported in this browser. Please use Chrome or Edge.');
                document.getElementById('voice-status-text').textContent = '🎤 Voice recognition not supported';
                showTextInputFallback();
                return;
            }

            try {
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = true; // Keep microphone always on
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'en-IN';
                speechRecognition.maxAlternatives = 1;

                speechRecognition.onstart = () => {
                    console.log('Speech recognition started');
                    isListening = true;
                    document.getElementById('listening-indicator').style.display = 'block';
                    document.getElementById('voice-status').style.background = 'linear-gradient(45deg, #ef4444, #dc2626)';
                    document.getElementById('voice-status-text').textContent = '🎤 Always listening for commands';
                };

                speechRecognition.onend = () => {
                    console.log('Speech recognition ended, immediately restarting...');
                    
                    // Don't change isListening to false to maintain continuous state
                    // Just restart immediately without any delay
                    if (voiceEnabled) {
                        try {
                            speechRecognition.start();
                            console.log('Speech recognition restarted successfully');
                        } catch (error) {
                            console.error('Error restarting speech recognition:', error);
                            // If immediate restart fails, try after a very short delay
                            setTimeout(() => {
                                if (voiceEnabled) {
                                    try {
                                        speechRecognition.start();
                                    } catch (retryError) {
                                        console.error('Retry failed:', retryError);
                                    }
                                }
                            }, 100);
                        }
                    }
                };

                speechRecognition.onresult = (event) => {
                    const result = event.results[0][0].transcript.toLowerCase().trim();
                    console.log('Voice command received:', result);
                    processVoiceCommand(result);
                };

                speechRecognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    
                    // Don't stop listening for most errors, just restart
                    if (event.error === 'not-allowed') {
                        // Only stop for permission denial
                        voiceEnabled = false;
                        isListening = false;
                        document.getElementById('voice-status-text').textContent = '🎤 Microphone access denied';
                        showTextInputFallback();
                        speakText('Microphone access denied. Using text input mode.');
                    } else {
                        // For other errors, restart immediately
                        console.log('Restarting after error:', event.error);
                        setTimeout(() => {
                            if (voiceEnabled) {
                                try {
                                    speechRecognition.start();
                                } catch (error) {
                                    console.error('Error restarting after error:', error);
                                }
                            }
                        }, 500);
                    }
                };

                console.log('Voice system initialized successfully');
                document.getElementById('voice-status-text').textContent = '🎤 Voice ready - Will start listening after welcome message';

            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                announceError('Voice recognition setup failed.');
                document.getElementById('voice-status-text').textContent = '🎤 Voice recognition unavailable';
                showTextInputFallback();
            }
        }

        function showTextInputFallback() {
            if (document.getElementById('text-command-form')) return;

            const main = document.querySelector('main');
            const textInputSection = document.createElement('section');
            textInputSection.className = 'mb-8';
            textInputSection.innerHTML = `
                <div class="glass p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4">
                        <i class="fas fa-keyboard text-blue-400 mr-2" aria-hidden="true"></i>
                        Text Command Input
                    </h2>
                    <form id="text-command-form">
                        <label for="text-command" class="sr-only">Enter your command</label>
                        <input type="text" id="text-command" class="w-full mb-4 bg-white/10 text-white" 
                               placeholder="Type your command (e.g., Find route to Marina Beach)" 
                               aria-label="Enter your command">
                        <button type="submit" class="bg-green-500 text-white px-8 py-4 rounded-xl text-xl font-bold">
                            Submit Command
                        </button>
                    </form>
                </div>
            `;

            main.insertBefore(textInputSection, main.children[1]);

            document.getElementById('text-command-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const command = document.getElementById('text-command').value.toLowerCase().trim();
                processVoiceCommand(command);
                document.getElementById('text-command').value = '';
            });
        }

        function startWelcomeSequence() {
            const welcomeMessage = voiceEnabled ? 
                `Welcome to Voice Navigate Chennai. I am your accessible navigation assistant. Voice recognition is now starting and will remain continuously active for your accessibility needs. The microphone will stay on at all times to listen for your commands. You can say things like "Find route to Marina Beach" or "Where am I" or "Help me navigate". When I find a route, you can say "Start navigation" or "Yes start" to begin. Say "Emergency assistance" for immediate help. The microphone is always ready, just speak your commands naturally. Current time is ${new Date().toLocaleTimeString()}. What would you like to do?` :
                `Welcome to Voice Navigate Chennai. I am your accessible navigation assistant. Voice features are currently disabled, but you can use the text input to enter commands like "Find route to Marina Beach" or "Where am I". Current time is ${new Date().toLocaleTimeString()}. What would you like to do?`;
            
            if (voiceEnabled) {
                speakText(welcomeMessage);
                // Start continuous listening immediately after welcome
                setTimeout(() => {
                    startListening();
                    // Set up a monitoring system to ensure it stays active
                    setInterval(() => {
                        if (voiceEnabled && !isListening) {
                            console.log('Voice recognition dropped, restarting...');
                            startListening();
                        }
                    }, 5000); // Check every 5 seconds
                }, 2000);
            } else {
                document.getElementById('screen-reader-announcements').textContent = welcomeMessage;
            }
        }

        function startListening() {
            if (!voiceEnabled || !speechRecognition) {
                console.log('Cannot start listening:', { voiceEnabled, speechRecognition: !!speechRecognition });
                return;
            }

            // Prevent multiple instances from starting
            if (isListening) {
                console.log('Already listening, skipping start');
                return;
            }

            try {
                console.log('Starting continuous speech recognition...');
                speechRecognition.start();
            } catch (error) {
                console.error('Error starting speech recognition:', error);
                if (error.name === 'InvalidStateError') {
                    // Speech recognition is already running, just update our state
                    console.log('Speech recognition already active');
                    isListening = true;
                } else {
                    // Try again after a short delay
                    setTimeout(() => {
                        if (voiceEnabled && !isListening) {
                            startListening();
                        }
                    }, 1000);
                }
            }
        }

        function processVoiceCommand(command) {
            console.log('Processing command:', command);

            const commands = [
                {
                    pattern: /(?:cancel|stop listening)/i,
                    handler: () => {
                        if (speechRecognition) {
                            speechRecognition.stop();
                        }
                        speakText('Voice listening stopped. Click the microphone button to restart.');
                    }
                },
                {
                    pattern: /(?:find route|navigate to|go to)\s+(.+)/i,
                    handler: (match) => handleRouteCommand(match[1])
                },
                {
                    pattern: /(?:start navigation|begin navigation|start route|yes start|yes begin)/i,
                    handler: () => {
                        if (currentRoute) {
                            startNavigation();
                        } else {
                            speakText('No route has been found yet. Please say "find route to" followed by your destination first.');
                        }
                    }
                },
                {
                    pattern: /(?:no|cancel navigation|don't start|do not start)/i,
                    handler: () => {
                        if (document.getElementById('route-announcement').style.display === 'block') {
                            closeRouteAnnouncement();
                            speakText('Navigation cancelled. What else would you like to do?');
                        }
                    }
                },
                {
                    pattern: /(?:stop navigation|end navigation|cancel route)/i,
                    handler: () => {
                        if (isNavigating) {
                            stopNavigation();
                        } else {
                            speakText('No navigation is currently active.');
                        }
                    }
                },
                {
                    pattern: /(?:where am i|current location|my location)/i,
                    handler: handleLocationCommand
                },
                {
                    pattern: /(?:help|commands|what can you do)/i,
                    handler: handleHelpCommand
                },
                {
                    pattern: /(?:emergency|help me|assistance)/i,
                    handler: handleEmergency
                },
                {
                    pattern: /(?:nearby|stations|transport)/i,
                    handler: handleNearbyStations
                },
                {
                    pattern: /(?:weather|temperature)/i,
                    handler: handleWeatherCommand
                },
                {
                    pattern: /(?:repeat|say again)/i,
                    handler: () => speakText(lastAnnouncement)
                },
                {
                    pattern: /(?:high contrast|contrast)/i,
                    handler: toggleHighContrast
                },
                {
                    pattern: /(?:transit|metro|bus status)/i,
                    handler: handleTransitStatus
                }
            ];

            const matchedCommand = commands.find(cmd => cmd.pattern.test(command));
            
            if (matchedCommand) {
                const match = command.match(matchedCommand.pattern);
                matchedCommand.handler(match);
            } else {
                const responseMessage = `I didn't understand "${command}". You can say things like "Find route to T Nagar", "Where am I", "Help me navigate", or "Show nearby stations".`;
                speakText(responseMessage);
            }
        }

        function handleRouteCommand(destinationInput) {
            const cleanDestination = destinationInput.trim().toLowerCase();
            destination = cleanDestination;
            
            document.getElementById('destination-status').textContent = destinationInput;
            
            speakText(`Searching for route to ${destinationInput}. Please wait.`);
            
            // Simulate route finding
            setTimeout(() => {
                const route = routeDatabase[cleanDestination] || generateGenericRoute(destinationInput);
                currentRoute = route;
                showRouteAnnouncement(route);
            }, 2000);
        }

        function generateGenericRoute(destination) {
            return {
                from: 'Current Location',
                to: destination,
                duration: '30 minutes',
                distance: '10 km',
                instructions: [
                    'Head to the nearest main road',
                    'Look for public transport options',
                    `Ask locals for directions to ${destination}`,
                    `Take appropriate transport towards ${destination}`,
                    `Get off at the nearest stop to ${destination}`,
                    `Walk to your final destination`
                ],
                transport: ['Walking', 'Public Transport']
            };
        }

        function showRouteAnnouncement(route) {
            const routeModal = document.getElementById('route-announcement');
            const routeDetails = document.getElementById('route-details');
            
            routeDetails.innerHTML = `
                <div class="mb-4">
                    <strong>From:</strong> ${route.from}<br>
                    <strong>To:</strong> ${route.to}<br>
                    <strong>Duration:</strong> ${route.duration}<br>
                    <strong>Distance:</strong> ${route.distance}
                </div>
                <div class="mb-4">
                    <strong>Transport:</strong> ${route.transport.join(', ')}
                </div>
                <div>
                    <strong>Instructions:</strong>
                    <ol class="list-decimal list-inside mt-2 space-y-2">
                        ${route.instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                    </ol>
                </div>
            `;
            
            routeModal.style.display = 'block';
            routeModal.focus();
            
            const announcement = `Route found to ${route.to}. Total duration: ${route.duration}. Distance: ${route.distance}. Transport needed: ${route.transport.join(' and ')}. Say "Start navigation" or "Yes start" to begin, or say "No" or "Cancel" to dismiss.`;
            speakText(announcement);
            lastAnnouncement = announcement;
        }

        function startNavigation() {
            if (!currentRoute) return;
            
            isNavigating = true;
            currentInstructionIndex = 0;
            
            closeRouteAnnouncement();
            
            const navigationSection = document.getElementById('navigation-section');
            navigationSection.style.display = 'block';
            
            updateNavigationInstructions();
            
            speakText(`Navigation started to ${currentRoute.to}. First instruction: ${currentRoute.instructions[0]}`);
            
            // Simulate navigation progress
            startNavigationUpdates();
        }

        function updateNavigationInstructions() {
            const instructionsDiv = document.getElementById('navigation-instructions');
            
            if (!currentRoute || !isNavigating) return;
            
            const currentInstruction = currentRoute.instructions[currentInstructionIndex];
            const nextInstruction = currentRoute.instructions[currentInstructionIndex + 1];
            
            instructionsDiv.innerHTML = `
                <div class="bg-green-500/20 p-4 rounded-lg mb-4">
                    <h3 class="font-bold text-green-400 mb-2">Current Instruction:</h3>
                    <p class="text-xl">${currentInstruction}</p>
                </div>
                ${nextInstruction ? `
                    <div class="bg-blue-500/20 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-400 mb-2">Next:</h3>
                        <p>${nextInstruction}</p>
                    </div>
                ` : `
                    <div class="bg-yellow-500/20 p-4 rounded-lg">
                        <h3 class="font-bold text-yellow-400 mb-2">Almost There!</h3>
                        <p>You're on the final step to reach your destination.</p>
                    </div>
                `}
                <div class="mt-4 text-sm text-gray-300">
                    Step ${currentInstructionIndex + 1} of ${currentRoute.instructions.length}
                </div>
            `;
        }

        function startNavigationUpdates() {
            // Simulate navigation progress every 30 seconds
            const navigationInterval = setInterval(() => {
                if (!isNavigating || !currentRoute) {
                    clearInterval(navigationInterval);
                    return;
                }
                
                currentInstructionIndex++;
                
                if (currentInstructionIndex >= currentRoute.instructions.length) {
                    // Navigation complete
                    completeNavigation();
                    clearInterval(navigationInterval);
                } else {
                    updateNavigationInstructions();
                    const nextInstruction = currentRoute.instructions[currentInstructionIndex];
                    speakText(`Next instruction: ${nextInstruction}`);
                }
            }, 30000); // 30 seconds between instructions
        }

        function completeNavigation() {
            isNavigating = false;
            const navigationSection = document.getElementById('navigation-section');
            navigationSection.style.display = 'none';
            
            speakText(`Congratulations! You have arrived at ${currentRoute.to}. Navigation complete.`);
            
            // Reset destination status
            document.getElementById('destination-status').textContent = 'None set';
            currentRoute = null;
            currentInstructionIndex = 0;
        }

        function stopNavigation() {
            isNavigating = false;
            const navigationSection = document.getElementById('navigation-section');
            navigationSection.style.display = 'none';
            
            speakText('Navigation stopped.');
            
            document.getElementById('destination-status').textContent = 'None set';
            currentRoute = null;
            currentInstructionIndex = 0;
        }

        function repeatInstruction() {
            if (currentRoute && isNavigating) {
                const currentInstruction = currentRoute.instructions[currentInstructionIndex];
                speakText(`Current instruction: ${currentInstruction}`);
            }
        }

        function closeRouteAnnouncement() {
            document.getElementById('route-announcement').style.display = 'none';
        }

        function handleLocationCommand() {
            if (!locationEnabled) {
                speakText('Location access is not available. Please enable location permissions in your browser settings and refresh the page.');
                return;
            }

            speakText('Detecting your current location. Please wait.');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(4);
                    const lng = position.coords.longitude.toFixed(4);
                    currentLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    
                    // Simulate reverse geocoding
                    const locationName = getLocationName(lat, lng);
                    document.getElementById('current-location').textContent = locationName;
                    
                    const message = `Your current location is ${locationName}. Coordinates: ${lat}, ${lng}. What would you like to do next?`;
                    speakText(message);
                    lastAnnouncement = message;
                },
                (error) => {
                    let errorMessage = 'Unable to detect your location. ';
                    if (error.code === 1) {
                        errorMessage += 'Please allow location access and try again.';
                    } else if (error.code === 2) {
                        errorMessage += 'Location information unavailable.';
                    } else if (error.code === 3) {
                        errorMessage += 'Location request timed out. Please try again.';
                    }
                    
                    speakText(errorMessage);
                    document.getElementById('current-location').textContent = 'Location unavailable';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        function getLocationName(lat, lng) {
            // Simulate location detection based on coordinates
            const locations = [
                'Near Anna Nagar', 'Near T Nagar', 'Near Marina Beach', 'Near Adyar',
                'Near Velachery', 'Near Guindy', 'Near Mylapore', 'Near Nungambakkam'
            ];
            return locations[Math.floor(Math.random() * locations.length)];
        }

        function handleHelpCommand() {
            toggleCommandHelp();
            const helpMessage = `Here are the voice commands you can use: 
                Say "Find route to" followed by your destination, like "Find route to Marina Beach". 
                Say "Start navigation" or "Yes start" to begin navigation after finding a route.
                Say "Stop navigation" to end current navigation.
                Say "Where am I" to get your current location. 
                Say "Show nearby stations" for transit options. 
                Say "Emergency assistance" for help. 
                Say "What's the weather" for weather information. 
                Say "Repeat" to hear the last announcement again. 
                Say "High contrast" to toggle high contrast mode. 
                The microphone is always listening for your commands. What would you like to do?`;
            speakText(helpMessage);
            lastAnnouncement = helpMessage;
        }

        function handleEmergency() {
            const emergencyMessage = `Emergency assistance activated. In a real emergency, call 100 for police, 101 for fire, or 108 for medical emergency. 
                For immediate help, try to get to the nearest public place or ask nearby people for assistance. 
                Your approximate location is ${document.getElementById('current-location').textContent}. 
                Stay calm and safe. Is there anything specific I can help you with?`;
            
            speakText(emergencyMessage);
            lastAnnouncement = emergencyMessage;
            
            // Visual emergency indicator
            document.body.style.border = '5px solid red';
            setTimeout(() => {
                document.body.style.border = 'none';
            }, 10000);
        }

        function handleNearbyStations() {
            speakText('Searching for nearby transit stations. Please wait.');
            
            setTimeout(() => {
                const stations = [
                    'Metro Station: 200 meters north - Blue Line',
                    'Bus Stop: 150 meters east - Routes 21G, 45B, 12A',
                    'Auto Stand: 300 meters south',
                    'Railway Station: 1.2 kilometers west - Suburban trains'
                ];
                
                const message = `Found nearby transit options: ${stations.join('. ')}. Which option would you like to use?`;
                speakText(message);
                lastAnnouncement = message;
                
                document.getElementById('next-transport').textContent = stations[0];
            }, 2000);
        }

        function handleWeatherCommand() {
            const weatherInfo = {
                temperature: Math.floor(Math.random() * 10) + 25, // 25-35°C
                condition: ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain'][Math.floor(Math.random() * 4)],
                humidity: Math.floor(Math.random() * 30) + 60 // 60-90%
            };
            
            const message = `Current weather in Chennai: ${weatherInfo.condition}, ${weatherInfo.temperature} degrees Celsius, humidity ${weatherInfo.humidity} percent. Good conditions for travel.`;
            speakText(message);
            lastAnnouncement = message;
            
            document.getElementById('weather-status').textContent = `${weatherInfo.condition}, ${weatherInfo.temperature}°C`;
        }

        function handleTransitStatus() {
            const message = `Current transit status: Metro services are running normally. Bus services have minor delays of 5 to 10 minutes. All major routes are operational. Weather conditions are good for travel.`;
            speakText(message);
            lastAnnouncement = message;
        }

        function toggleHighContrast() {
            isHighContrast = !isHighContrast;
            document.body.classList.toggle('high-contrast', isHighContrast);
            
            const message = isHighContrast ? 'High contrast mode enabled.' : 'High contrast mode disabled.';
            speakText(message);
        }

        function toggleCommandHelp() {
            const helpPanel = document.getElementById('command-help');
            const isVisible = helpPanel.style.display !== 'none';
            helpPanel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                helpPanel.focus();
            }
        }

        function toggleListening() {
            if (!voiceEnabled) {
                speakText('Voice recognition is not enabled. Please refresh the page and allow microphone access, or use the text input.');
                return;
            }

            // Since we want always-on listening, this function now just shows status
            if (isListening) {
                speakText('Voice recognition is currently active and listening continuously.');
            } else {
                speakText('Restarting voice recognition...');
                startListening();
            }
        }

        function triggerVoiceCommand(command) {
            processVoiceCommand(command);
        }

        function detectCurrentLocation() {
            if (!locationEnabled) {
                document.getElementById('current-location').textContent = 'Location access not enabled';
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        const locationName = getLocationName(position.coords.latitude, position.coords.longitude);
                        document.getElementById('current-location').textContent = locationName;
                    },
                    (error) => {
                        console.error('Location error:', error);
                        document.getElementById('current-location').textContent = 'Location unavailable';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                document.getElementById('current-location').textContent = 'Geolocation not supported';
            }
        }

        function updateTransitInfo() {
            // Simulate real-time transit updates
            setInterval(() => {
                const metroStatuses = ['Normal Service', 'Minor Delays', 'Good Service'];
                const busStatuses = ['Normal Service', 'Minor Delays', 'Heavy Traffic'];
                
                document.getElementById('metro-status').textContent = 
                    metroStatuses[Math.floor(Math.random() * metroStatuses.length)];
                document.getElementById('bus-status').textContent = 
                    busStatuses[Math.floor(Math.random() * busStatuses.length)];
            }, 60000); // Update every minute
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                // Alt + H for help
                if (event.altKey && event.key === 'h') {
                    event.preventDefault();
                    handleHelpCommand();
                }
                
                // Alt + L for location
                if (event.altKey && event.key === 'l') {
                    event.preventDefault();
                    handleLocationCommand();
                }
                
                // Alt + E for emergency
                if (event.altKey && event.key === 'e') {
                    event.preventDefault();
                    handleEmergency();
                }
                
                // Alt + C for high contrast
                if (event.altKey && event.key === 'c') {
                    event.preventDefault();
                    toggleHighContrast();
                }
                
                // Alt + M for microphone toggle
                if (event.altKey && event.key === 'm') {
                    event.preventDefault();
                    toggleListening();
                }
                
                // Escape to close modals
                if (event.key === 'Escape') {
                    closeRouteAnnouncement();
                    document.getElementById('command-help').style.display = 'none';
                }
            });
        }

        function speakText(text) {
            if (!voiceEnabled) {
                // If voice is disabled, just update screen reader
                document.getElementById('screen-reader-announcements').textContent = text;
                return;
            }

            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            isSpeaking = true;
            lastAnnouncement = text;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onend = () => {
                isSpeaking = false;
            };
            
            utterance.onerror = (error) => {
                console.error('Speech synthesis error:', error);
                isSpeaking = false;
            };
            
            // Update screen reader
            document.getElementById('screen-reader-announcements').textContent = text;
            
            try {
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Error speaking text:', error);
                isSpeaking = false;
            }
        }

        function announceError(message) {
            console.error(message);
            if (voiceEnabled) {
                speakText(message);
            } else {
                document.getElementById('screen-reader-announcements').textContent = message;
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (speechRecognition) {
                speechRecognition.stop();
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });

        // Handle visibility change - keep listening even when tab is not active
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page hidden, but keeping voice recognition active for accessibility');
                // Don't stop speech recognition when page is hidden
                // This is crucial for blind users who might switch between apps
            } else {
                console.log('Page visible again');
                // Ensure voice recognition is still running
                if (voiceEnabled && !isListening) {
                    setTimeout(() => {
                        startListening();
                    }, 500);
                }
            }
        });
    </script>
</body>
</html>